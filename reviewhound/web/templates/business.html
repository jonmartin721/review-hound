{% extends "base.html" %}

{% block title %}{{ business.name }} - Review Hound{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('main.dashboard') }}" class="text-indigo-600 hover:text-indigo-800">← Back to Dashboard</a>
</div>

<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ business.name }}</h1>
            {% if business.address %}
            <p class="text-gray-500 mt-1">{{ business.address }}</p>
            {% endif %}
        </div>
        <div class="flex gap-2">
            <button onclick="openEditModal()"
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 transition">
                Edit
            </button>
            <button onclick="confirmDelete()"
                    class="bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200 transition">
                Delete
            </button>
            <button onclick="triggerScrape({{ business.id }})"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
                    id="scrape-btn">
                Scrape Now
            </button>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-indigo-600">{{ stats.total_reviews }}</div>
            <div class="text-sm text-gray-500">Total Reviews</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-yellow-500">{{ "%.1f"|format(stats.avg_rating) }}★</div>
            <div class="text-sm text-gray-500">Avg Rating</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-green-500">{{ "%.0f"|format(stats.positive_pct) }}%</div>
            <div class="text-sm text-gray-500">Positive</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-red-500">{{ "%.0f"|format(stats.negative_pct) }}%</div>
            <div class="text-sm text-gray-500">Negative</div>
        </div>
    </div>

    <div class="flex flex-wrap gap-2 mt-6">
        {% if business.trustpilot_url %}
        <a href="{{ business.trustpilot_url }}" target="_blank" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">TrustPilot ↗</a>
        {% endif %}
        {% if business.bbb_url %}
        <a href="{{ business.bbb_url }}" target="_blank" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">BBB ↗</a>
        {% endif %}
        {% if business.yelp_url %}
        <a href="{{ business.yelp_url }}" target="_blank" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">Yelp ↗</a>
        {% endif %}
        {% if business.google_place_id %}
        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded">Google (API)</span>
        {% endif %}
        {% if business.yelp_business_id %}
        <span class="px-3 py-1 bg-red-100 text-red-700 rounded">Yelp (API)</span>
        {% endif %}
    </div>
</div>

<!-- Rating Trend Chart -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Rating Trend</h2>
    <canvas id="ratingChart" height="100"></canvas>
</div>

<!-- Recent Reviews -->
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Recent Reviews</h2>
        <a href="{{ url_for('main.business_reviews', business_id=business.id) }}" class="text-indigo-600 hover:text-indigo-800">View All →</a>
    </div>

    {% if reviews %}
    <div class="space-y-4">
        {% for r in reviews[:5] %}
        <div class="border-b pb-4 last:border-b-0">
            <div class="flex justify-between items-start">
                <div class="flex items-center space-x-2">
                    <span class="font-medium text-gray-800">{{ r.author_name or 'Anonymous' }}</span>
                    <span class="text-yellow-500">{{ '★' * (r.rating|int) if r.rating else '' }}</span>
                    <span class="px-2 py-0.5 text-xs rounded {% if r.sentiment_label == 'positive' %}bg-green-100 text-green-700{% elif r.sentiment_label == 'negative' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                        {{ r.sentiment_label or 'neutral' }}
                    </span>
                </div>
                <span class="text-sm text-gray-400">{{ r.source }}</span>
            </div>
            <p class="text-gray-600 mt-2">{{ r.text[:200] }}{{ '...' if r.text and r.text|length > 200 else '' }}</p>
            <p class="text-xs text-gray-400 mt-1">{{ r.review_date or r.scraped_at.strftime('%Y-%m-%d') }}</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-4">No reviews yet. Click "Scrape Now" to fetch reviews.</p>
    {% endif %}
</div>

<!-- Email Alerts -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Email Alerts</h2>
        <button onclick="openAlertModal()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition">
            + Add Alert
        </button>
    </div>
    <p class="text-sm text-gray-500 mb-4">Get notified when negative reviews are detected.</p>
    <div id="alertsList">
        <p class="text-gray-400 text-center py-4">Loading alerts...</p>
    </div>
</div>

<!-- Scrape History -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Scrape History</h2>
    {% if scrape_logs %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left">Source</th>
                    <th class="px-4 py-2 text-left">Status</th>
                    <th class="px-4 py-2 text-left">Reviews Found</th>
                    <th class="px-4 py-2 text-left">Time</th>
                </tr>
            </thead>
            <tbody>
                {% for log in scrape_logs[:10] %}
                <tr class="border-t">
                    <td class="px-4 py-2">{{ log.source }}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-0.5 rounded text-xs {% if log.status == 'success' %}bg-green-100 text-green-700{% elif log.status == 'failed' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {{ log.status }}
                        </span>
                    </td>
                    <td class="px-4 py-2">{{ log.reviews_found or 0 }}</td>
                    <td class="px-4 py-2 text-gray-500">{{ log.completed_at.strftime('%Y-%m-%d %H:%M') if log.completed_at else 'Running...' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-4">No scrape history yet.</p>
    {% endif %}
</div>

<!-- Edit Business Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Edit Business</h2>
            <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <form id="editForm" onsubmit="submitEdit(event)">
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Business Name *</label>
                    <input type="text" id="editName" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <input type="text" id="editAddress" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>
                <p class="text-sm font-medium text-gray-600 pt-2 border-t">Web Scraping Sources</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">TrustPilot URL</label>
                    <input type="url" id="editTrustpilot" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">BBB URL</label>
                    <input type="url" id="editBbb" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Yelp URL</label>
                    <input type="url" id="editYelp" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>
                <p class="text-sm font-medium text-gray-600 pt-2 border-t">API Sources (requires API keys in Settings)</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Google Place ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="editGooglePlaceId" class="flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="e.g., ChIJN1t_tDeuEmsRUsoyG83frY4">
                        <button type="button" onclick="searchGooglePlaces()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">Search</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Yelp Business ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="editYelpBusinessId" class="flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="e.g., gary-danko-san-francisco">
                        <button type="button" onclick="searchYelpBusiness()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">Search</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" onclick="closeEditModal()" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" id="editSubmitBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Changes</button>
            </div>
        </form>
        <!-- Search Results Panel -->
        <div id="searchResultsPanel" class="hidden mt-4 border-t pt-4">
            <h3 id="searchResultsTitle" class="font-medium text-gray-800 mb-2">Search Results</h3>
            <div id="searchResultsList" class="max-h-48 overflow-y-auto space-y-2"></div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h2 id="alertModalTitle" class="text-xl font-bold text-gray-800">Add Alert</h2>
            <button onclick="closeAlertModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <form id="alertForm" onsubmit="submitAlert(event)">
            <input type="hidden" id="alertId" value="">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                    <input type="email" id="alertEmail" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating Threshold</label>
                    <p class="text-xs text-gray-500 mb-2">Alert when rating is at or below this value</p>
                    <select id="alertThreshold" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                        <option value="1">1 star</option>
                        <option value="2">2 stars</option>
                        <option value="3" selected>3 stars</option>
                        <option value="4">4 stars</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="alertEnabled" checked class="rounded text-indigo-600 mr-2">
                    <label for="alertEnabled" class="text-sm text-gray-700">Enabled</label>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeAlertModal()" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" id="alertSubmitBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Delete Business</h2>
        <p class="text-gray-600 mb-6">Are you sure you want to delete "{{ business.name }}"? This will also delete all reviews and alerts. This action cannot be undone.</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeDeleteModal()" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-50">Cancel</button>
            <button onclick="deleteBusiness()" id="deleteConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const businessId = {{ business.id }};

// Scrape functionality
async function triggerScrape(businessId) {
    const btn = document.getElementById('scrape-btn');
    btn.disabled = true;
    btn.textContent = 'Scraping...';

    try {
        const response = await fetch(`/business/${businessId}/scrape`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            btn.textContent = 'Done!';
            if (data.failed_sources) {
                alert(`Some sources failed: ${data.failed_sources.join(', ')}`);
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            btn.textContent = 'Failed';
            alert(data.error || 'Scrape failed');
            setTimeout(() => { btn.textContent = 'Scrape Now'; btn.disabled = false; }, 2000);
        }
    } catch (e) {
        btn.textContent = 'Error';
        alert('Error connecting to server');
        setTimeout(() => { btn.textContent = 'Scrape Now'; btn.disabled = false; }, 2000);
    }
}

// Edit Modal
async function openEditModal() {
    const response = await fetch(`/api/business/${businessId}`);
    const data = await response.json();
    if (data.success) {
        document.getElementById('editName').value = data.business.name || '';
        document.getElementById('editAddress').value = data.business.address || '';
        document.getElementById('editTrustpilot').value = data.business.trustpilot_url || '';
        document.getElementById('editBbb').value = data.business.bbb_url || '';
        document.getElementById('editYelp').value = data.business.yelp_url || '';
        document.getElementById('editGooglePlaceId').value = data.business.google_place_id || '';
        document.getElementById('editYelpBusinessId').value = data.business.yelp_business_id || '';
    }
    document.getElementById('searchResultsPanel').classList.add('hidden');
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModal').classList.add('flex');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
}

async function submitEdit(event) {
    event.preventDefault();
    const btn = document.getElementById('editSubmitBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const response = await fetch(`/api/business/${businessId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('editName').value,
                address: document.getElementById('editAddress').value || null,
                trustpilot_url: document.getElementById('editTrustpilot').value || null,
                bbb_url: document.getElementById('editBbb').value || null,
                yelp_url: document.getElementById('editYelp').value || null,
                google_place_id: document.getElementById('editGooglePlaceId').value || null,
                yelp_business_id: document.getElementById('editYelpBusinessId').value || null,
            })
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert(result.error || 'Failed to update');
            btn.disabled = false;
            btn.textContent = 'Save Changes';
        }
    } catch (e) {
        alert('Error updating business');
        btn.disabled = false;
        btn.textContent = 'Save Changes';
    }
}

// API Search Functions
async function searchGooglePlaces() {
    const name = document.getElementById('editName').value;
    const address = document.getElementById('editAddress').value;
    if (!name) {
        alert('Enter a business name first');
        return;
    }

    document.getElementById('searchResultsTitle').textContent = 'Google Places Results';
    document.getElementById('searchResultsList').innerHTML = '<p class="text-gray-500">Searching...</p>';
    document.getElementById('searchResultsPanel').classList.remove('hidden');

    try {
        const response = await fetch('/api/search-google-places', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: name, location: address })
        });
        const data = await response.json();

        if (data.success && data.results.length > 0) {
            document.getElementById('searchResultsList').innerHTML = data.results.map(r => `
                <div class="p-2 border rounded hover:bg-gray-50 cursor-pointer" onclick="selectGooglePlace('${r.place_id}')">
                    <div class="font-medium">${escapeHtml(r.name)}</div>
                    <div class="text-sm text-gray-500">${escapeHtml(r.address || '')}</div>
                    ${r.rating ? `<div class="text-sm text-yellow-600">${r.rating}★ (${r.review_count} reviews)</div>` : ''}
                </div>
            `).join('');
        } else {
            document.getElementById('searchResultsList').innerHTML = `<p class="text-gray-500">${data.error || 'No results found'}</p>`;
        }
    } catch (e) {
        document.getElementById('searchResultsList').innerHTML = '<p class="text-red-500">Search failed</p>';
    }
}

async function searchYelpBusiness() {
    const name = document.getElementById('editName').value;
    const address = document.getElementById('editAddress').value;
    if (!name) {
        alert('Enter a business name first');
        return;
    }

    document.getElementById('searchResultsTitle').textContent = 'Yelp Results';
    document.getElementById('searchResultsList').innerHTML = '<p class="text-gray-500">Searching...</p>';
    document.getElementById('searchResultsPanel').classList.remove('hidden');

    try {
        const response = await fetch('/api/search-yelp', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: name, location: address || 'United States' })
        });
        const data = await response.json();

        if (data.success && data.results.length > 0) {
            document.getElementById('searchResultsList').innerHTML = data.results.map(r => `
                <div class="p-2 border rounded hover:bg-gray-50 cursor-pointer" onclick="selectYelpBusiness('${r.business_id}')">
                    <div class="font-medium">${escapeHtml(r.name)}</div>
                    <div class="text-sm text-gray-500">${escapeHtml(r.address || '')}</div>
                    ${r.rating ? `<div class="text-sm text-yellow-600">${r.rating}★ (${r.review_count} reviews)</div>` : ''}
                </div>
            `).join('');
        } else {
            document.getElementById('searchResultsList').innerHTML = `<p class="text-gray-500">${data.error || 'No results found'}</p>`;
        }
    } catch (e) {
        document.getElementById('searchResultsList').innerHTML = '<p class="text-red-500">Search failed</p>';
    }
}

function selectGooglePlace(placeId) {
    document.getElementById('editGooglePlaceId').value = placeId;
    document.getElementById('searchResultsPanel').classList.add('hidden');
}

function selectYelpBusiness(businessId) {
    document.getElementById('editYelpBusinessId').value = businessId;
    document.getElementById('searchResultsPanel').classList.add('hidden');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Delete Modal
function confirmDelete() {
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deleteModal').classList.add('flex');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('flex');
}

async function deleteBusiness() {
    const btn = document.getElementById('deleteConfirmBtn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
        const response = await fetch(`/api/business/${businessId}`, { method: 'DELETE' });
        const result = await response.json();
        if (result.success) {
            window.location.href = '/';
        } else {
            alert(result.error || 'Failed to delete');
            btn.disabled = false;
            btn.textContent = 'Delete';
        }
    } catch (e) {
        alert('Error deleting business');
        btn.disabled = false;
        btn.textContent = 'Delete';
    }
}

// Alert Modal
function openAlertModal(alertData = null) {
    document.getElementById('alertModalTitle').textContent = alertData ? 'Edit Alert' : 'Add Alert';
    document.getElementById('alertId').value = alertData ? alertData.id : '';
    document.getElementById('alertEmail').value = alertData ? alertData.email : '';
    document.getElementById('alertThreshold').value = alertData ? alertData.negative_threshold : '3';
    document.getElementById('alertEnabled').checked = alertData ? alertData.enabled : true;
    document.getElementById('alertEmail').readOnly = !!alertData;
    document.getElementById('alertModal').classList.remove('hidden');
    document.getElementById('alertModal').classList.add('flex');
}

function closeAlertModal() {
    document.getElementById('alertModal').classList.add('hidden');
    document.getElementById('alertModal').classList.remove('flex');
}

async function submitAlert(event) {
    event.preventDefault();
    const btn = document.getElementById('alertSubmitBtn');
    const alertId = document.getElementById('alertId').value;
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const data = {
        email: document.getElementById('alertEmail').value,
        negative_threshold: parseFloat(document.getElementById('alertThreshold').value),
        enabled: document.getElementById('alertEnabled').checked,
    };

    try {
        const url = alertId ? `/api/alerts/${alertId}` : `/api/business/${businessId}/alerts`;
        const method = alertId ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            closeAlertModal();
            loadAlerts();
        } else {
            alert(result.error || 'Failed to save alert');
        }
    } catch (e) {
        alert('Error saving alert');
    }
    btn.disabled = false;
    btn.textContent = 'Save';
}

async function deleteAlert(alertId) {
    if (!confirm('Delete this alert?')) return;
    try {
        const response = await fetch(`/api/alerts/${alertId}`, { method: 'DELETE' });
        const result = await response.json();
        if (result.success) {
            loadAlerts();
        } else {
            alert(result.error || 'Failed to delete alert');
        }
    } catch (e) {
        alert('Error deleting alert');
    }
}

async function loadAlerts() {
    const container = document.getElementById('alertsList');
    try {
        const response = await fetch(`/api/business/${businessId}/alerts`);
        const data = await response.json();
        if (data.success && data.alerts.length > 0) {
            container.innerHTML = data.alerts.map(a => `
                <div class="flex justify-between items-center py-3 border-b last:border-b-0">
                    <div>
                        <span class="font-medium">${a.email}</span>
                        <span class="text-sm text-gray-500 ml-2">Alert on ≤${a.negative_threshold}★</span>
                        <span class="ml-2 px-2 py-0.5 text-xs rounded ${a.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">${a.enabled ? 'Active' : 'Disabled'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='openAlertModal(${JSON.stringify(a)})' class="text-indigo-600 hover:text-indigo-800 text-sm">Edit</button>
                        <button onclick="deleteAlert(${a.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">No alerts configured. Click "+ Add Alert" to get notified about negative reviews.</p>';
        }
    } catch (e) {
        container.innerHTML = '<p class="text-red-400 text-center py-4">Failed to load alerts.</p>';
    }
}

// Load alerts on page load
loadAlerts();

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
        closeDeleteModal();
        closeAlertModal();
    }
});

// Close modals on backdrop click
['editModal', 'deleteModal', 'alertModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            this.classList.remove('flex');
        }
    });
});

// Rating trend chart
const ctx = document.getElementById('ratingChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels|safe }},
        datasets: [{
            label: 'Average Rating',
            data: {{ chart_data|safe }},
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { min: 1, max: 5 }
        },
        plugins: {
            legend: { display: false }
        }
    }
});
</script>
{% endblock %}
