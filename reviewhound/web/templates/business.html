{% extends "base.html" %}

{% block title %}{{ business.name }} - Review Hound{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('main.dashboard') }}" class="text-indigo-600 hover:text-indigo-800">← Back to Dashboard</a>
</div>

<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ business.name }}</h1>
            {% if business.address %}
            <p class="text-gray-500 mt-1">{{ business.address }}</p>
            {% endif %}
        </div>
        <button onclick="triggerScrape({{ business.id }})"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
                id="scrape-btn">
            Scrape Now
        </button>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-indigo-600">{{ stats.total_reviews }}</div>
            <div class="text-sm text-gray-500">Total Reviews</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-yellow-500">{{ "%.1f"|format(stats.avg_rating) }}★</div>
            <div class="text-sm text-gray-500">Avg Rating</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-green-500">{{ "%.0f"|format(stats.positive_pct) }}%</div>
            <div class="text-sm text-gray-500">Positive</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-red-500">{{ "%.0f"|format(stats.negative_pct) }}%</div>
            <div class="text-sm text-gray-500">Negative</div>
        </div>
    </div>

    <div class="flex space-x-2 mt-6">
        {% if business.trustpilot_url %}
        <a href="{{ business.trustpilot_url }}" target="_blank" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">TrustPilot ↗</a>
        {% endif %}
        {% if business.bbb_url %}
        <a href="{{ business.bbb_url }}" target="_blank" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">BBB ↗</a>
        {% endif %}
        {% if business.yelp_url %}
        <a href="{{ business.yelp_url }}" target="_blank" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">Yelp ↗</a>
        {% endif %}
    </div>
</div>

<!-- Rating Trend Chart -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Rating Trend</h2>
    <canvas id="ratingChart" height="100"></canvas>
</div>

<!-- Recent Reviews -->
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Recent Reviews</h2>
        <a href="{{ url_for('main.business_reviews', business_id=business.id) }}" class="text-indigo-600 hover:text-indigo-800">View All →</a>
    </div>

    {% if reviews %}
    <div class="space-y-4">
        {% for r in reviews[:5] %}
        <div class="border-b pb-4 last:border-b-0">
            <div class="flex justify-between items-start">
                <div class="flex items-center space-x-2">
                    <span class="font-medium text-gray-800">{{ r.author_name or 'Anonymous' }}</span>
                    <span class="text-yellow-500">{{ '★' * (r.rating|int) if r.rating else '' }}</span>
                    <span class="px-2 py-0.5 text-xs rounded {% if r.sentiment_label == 'positive' %}bg-green-100 text-green-700{% elif r.sentiment_label == 'negative' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                        {{ r.sentiment_label or 'neutral' }}
                    </span>
                </div>
                <span class="text-sm text-gray-400">{{ r.source }}</span>
            </div>
            <p class="text-gray-600 mt-2">{{ r.text[:200] }}{{ '...' if r.text and r.text|length > 200 else '' }}</p>
            <p class="text-xs text-gray-400 mt-1">{{ r.review_date or r.scraped_at.strftime('%Y-%m-%d') }}</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-4">No reviews yet. Click "Scrape Now" to fetch reviews.</p>
    {% endif %}
</div>

<!-- Scrape History -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Scrape History</h2>
    {% if scrape_logs %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left">Source</th>
                    <th class="px-4 py-2 text-left">Status</th>
                    <th class="px-4 py-2 text-left">Reviews Found</th>
                    <th class="px-4 py-2 text-left">Time</th>
                </tr>
            </thead>
            <tbody>
                {% for log in scrape_logs[:10] %}
                <tr class="border-t">
                    <td class="px-4 py-2">{{ log.source }}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-0.5 rounded text-xs {% if log.status == 'success' %}bg-green-100 text-green-700{% elif log.status == 'failed' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {{ log.status }}
                        </span>
                    </td>
                    <td class="px-4 py-2">{{ log.reviews_found or 0 }}</td>
                    <td class="px-4 py-2 text-gray-500">{{ log.completed_at.strftime('%Y-%m-%d %H:%M') if log.completed_at else 'Running...' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-4">No scrape history yet.</p>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function triggerScrape(businessId) {
    const btn = document.getElementById('scrape-btn');
    btn.disabled = true;
    btn.textContent = 'Scraping...';

    try {
        const response = await fetch(`/business/${businessId}/scrape`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            btn.textContent = 'Done!';
            setTimeout(() => location.reload(), 1000);
        } else {
            btn.textContent = 'Failed';
            setTimeout(() => { btn.textContent = 'Scrape Now'; btn.disabled = false; }, 2000);
        }
    } catch (e) {
        btn.textContent = 'Error';
        setTimeout(() => { btn.textContent = 'Scrape Now'; btn.disabled = false; }, 2000);
    }
}

// Rating trend chart
const ctx = document.getElementById('ratingChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels|safe }},
        datasets: [{
            label: 'Average Rating',
            data: {{ chart_data|safe }},
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { min: 1, max: 5 }
        },
        plugins: {
            legend: { display: false }
        }
    }
});
</script>
{% endblock %}
